---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { ProjectPage } from "@/components/dashboard/project-page";
import { auth } from "@/lib/auth";

import { db } from "@/lib/db";
import { projects, users } from "../../../db/schema";
import { eq } from "drizzle-orm";

const session = await auth.api.getSession({ headers: Astro.request.headers });
if (!session) return Astro.redirect("/login");

const { id } = Astro.params;
if (!id) return Astro.redirect("/");

// 1. Fetch User (Global Role), Active Session (Active Org), Project, and Memberships (Access) in Parallel

// User Query
const userQuery = db.select().from(users).where(eq(users.id, session.user.id));

// Session Query (Active Org)
const sessionQuery = db.query.sessions.findFirst({
    where: (sessions, { eq }) => eq(sessions.id, session.session.id),
});

// Project Query
const projectQuery = db.select().from(projects).where(eq(projects.id, id));

// Memberships Query (All user memberships to check access against project.organizationId)
// We fetch all because it's usually a small list and saves a round trip compared to checking just one if we didn't know the orgId yet
const membershipsQuery = db.query.memberships.findMany({
    where: (memberships, { eq }) => eq(memberships.userId, session.user.id),
});

const [[currentUser], sessionData, [project], userMemberships] =
    await Promise.all([
        userQuery,
        sessionQuery,
        projectQuery,
        membershipsQuery,
    ]);

// 2. Access Control Logic (In-Memory)

let allowed = false;

if (project) {
    const isSuperAdmin = currentUser?.globalRole === "super_admin";

    if (isSuperAdmin) {
        allowed = true;
    } else if (project.userId === session.user.id) {
        // Personal project owner
        allowed = true;
    } else if (project.organizationId) {
        // Check if user is member of the project's organization
        const hasMembership = userMemberships.some(
            (m) => m.organizationId === project.organizationId,
        );
        allowed = hasMembership;
    }
}

if (!allowed || !project) {
    return Astro.redirect("/dashboard"); // Or 404/403 page
}

// We are reverting to CSR for this page to fix performance/interactivity issues
// Data will be fetched on the client side by `ProjectDetails` component
---

<DashboardLayout title={`Projeto: ${project.name}`}>
    <ProjectPage client:load id={id} />
</DashboardLayout>
