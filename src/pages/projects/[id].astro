---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { ProjectPage } from "@/components/dashboard/project-page";
import { getPageContext } from "@/lib/queries/page-context";
import { db } from "@/lib/db";
import { projects } from "../../../db/schema";
import { eq } from "drizzle-orm";

const ctx = await getPageContext(Astro.request.headers);
if (!ctx) return Astro.redirect("/login");

const { id } = Astro.params;
if (!id) return Astro.redirect("/");

// Fetch project (the only page-specific query needed)
const [project] = await db.select().from(projects).where(eq(projects.id, id));

// Access control (in-memory using data from getPageContext)
let allowed = false;
if (project) {
    if (ctx.isSuperAdmin) {
        allowed = true;
    } else if (project.userId === ctx.session.user.id) {
        allowed = true;
    } else if (project.organizationId) {
        // orgIds already contains the user's accessible org IDs
        allowed = ctx.orgIds === null || ctx.orgIds.includes(project.organizationId);
    }
}

if (!allowed || !project) {
    return Astro.redirect("/dashboard");
}
---

<DashboardLayout
    title={`Projeto: ${project.name}`}
    session={ctx.session}
    orgSessionData={ctx.orgSessionData}
>
    <ProjectPage client:load id={id} />
</DashboardLayout>
