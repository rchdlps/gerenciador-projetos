---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { KnowledgeAreasPage } from "@/components/dashboard/knowledge-areas-page";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { db } from "@/lib/db";
import { knowledgeAreas } from "../../../../db/schema";
import { getPageContext } from "@/lib/queries/page-context";
import { eq } from "drizzle-orm";

const ctx = await getPageContext(Astro.request.headers);
if (!ctx) return Astro.redirect("/login");

const { id } = Astro.params;
if (!id) return Astro.redirect("/");

// SSR Data Fetching
const initialData = await db
    .select()
    .from(knowledgeAreas)
    .where(eq(knowledgeAreas.projectId, id));
---

<DashboardLayout
    title="Áreas de Conhecimento"
    session={ctx.session}
    orgSessionData={ctx.orgSessionData}
>
    <div class="space-y-6">
        <div class="flex items-center gap-2">
            <Button
                variant="ghost"
                className="pl-0 hover:bg-transparent"
                asChild
            >
                <a
                    href={`/projects/${id}`}
                    class="flex items-center gap-2 text-primary font-semibold"
                >
                    <ArrowLeft className="h-4 w-4" /> Voltar para o Projeto
                </a>
            </Button>
        </div>

        <div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-900">
                Áreas de Conhecimento
            </h1>
            <p class="text-slate-500">
                Gerencie e documente os aspectos técnicos do projeto.
            </p>
        </div>

        <KnowledgeAreasPage
            client:load
            projectId={id}
            initialData={initialData}
            orgSessionData={ctx.orgSessionData}
        />
    </div>
</DashboardLayout>
