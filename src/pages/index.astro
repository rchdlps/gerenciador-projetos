---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { DashboardWrapper } from "@/components/dashboard/wrapper";
import ProjectListFallback from "@/components/dashboard/ProjectListFallback.astro";
import { getPageContext } from "@/lib/queries/page-context";
import { scopedProjects } from "@/lib/queries/scoped";
import { type projects } from "../../db/schema";

const ctx = await getPageContext(Astro.request.headers);
if (!ctx) return Astro.redirect("/login");

let initialProjects: (typeof projects.$inferSelect)[] = [];

try {
    initialProjects = await scopedProjects(ctx.orgIds);
} catch (error) {
    console.error("Failed to fetch projects:", error);
}
---

<DashboardLayout
    title="Dashboard - Gerenciador de Projetos"
    session={ctx.session}
    orgSessionData={ctx.orgSessionData}
>
    <DashboardWrapper
        client:idle
        initialData={ctx.orgSessionData}
        initialProjects={initialProjects}
    >
        <ProjectListFallback
            slot="fallback"
            initialProjects={initialProjects}
            organizations={ctx.orgSessionData?.organizations ?? []}
        />
    </DashboardWrapper>
</DashboardLayout>
