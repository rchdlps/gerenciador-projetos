---
import Layout from "../layouts/AuthLayout.astro";
---

<Layout title="Recuperar Senha">
    <div class="w-full max-w-md space-y-8">
        <div class="text-center">
            <h2 class="mt-6 text-3xl font-bold tracking-tight text-foreground">
                Recuperar Senha
            </h2>
            <p class="mt-2 text-sm text-muted-foreground">
                Informe seu email e enviaremos um link para você redefinir sua
                senha.
            </p>
        </div>

        <form id="forgot-password-form" class="mt-8 space-y-6">
            <div>
                <label for="email" class="sr-only">Email address</label>
                <input
                    id="email"
                    name="email"
                    type="email"
                    autocomplete="email"
                    required
                    class="relative block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 pl-2"
                    placeholder="Email"
                />
            </div>

            <div>
                <button
                    type="submit"
                    class="group relative flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
                >
                    Enviar Link de Recuperação
                </button>
            </div>
            <div class="text-sm text-center">
                <a
                    href="/login"
                    class="font-medium text-indigo-600 hover:text-indigo-500"
                >
                    Voltar para o login
                </a>
            </div>
        </form>
    </div>

    <script>
        import { authClient } from "@/lib/auth-client";
        import { toast } from "sonner";

        const form = document.getElementById(
            "forgot-password-form",
        ) as HTMLFormElement;

        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const email = formData.get("email") as string;
                const btn = form.querySelector("button");
                if (btn) {
                    btn.textContent = "Enviando...";
                    btn.disabled = true;
                }

                try {
                    const { error } = await (
                        authClient as any
                    ).requestPasswordReset({
                        email,
                        redirectTo: window.location.origin + "/reset-password", // This is where the user will be redirected to after clicking the link in email
                    });

                    if (error) {
                        toast.error(error.message);
                    } else {
                        toast.success(
                            "Email de recuperação enviado! Verifique sua caixa de entrada.",
                        );
                        form.reset();
                    }
                } catch (err) {
                    toast.error("Ocorreu um erro ao enviar o email.");
                } finally {
                    if (btn) {
                        btn.textContent = "Enviar Link de Recuperação";
                        btn.disabled = false;
                    }
                }
            });
        }
    </script>
</Layout>
