---
import Layout from "../../layouts/AuthLayout.astro";

const token = Astro.url.searchParams.get("token");

if (!token) {
    return Astro.redirect("/forgot-password");
}
---

<Layout title="Redefinir Senha">
    <div class="w-full max-w-md space-y-8">
        <div class="text-center">
            <h2 class="mt-6 text-3xl font-bold tracking-tight text-foreground">
                Criar Nova Senha
            </h2>
            <p class="mt-2 text-sm text-muted-foreground">
                Digite sua nova senha abaixo.
            </p>
        </div>

        <form id="reset-password-form" class="mt-8 space-y-6">
            <div>
                <label for="password" class="sr-only">Nova Senha</label>
                <input
                    id="password"
                    name="password"
                    type="password"
                    required
                    class="relative block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 pl-2"
                    placeholder="Nova Senha"
                    minlength="8"
                />
            </div>
            <div>
                <label for="confirm-password" class="sr-only"
                    >Confirmar Senha</label
                >
                <input
                    id="confirm-password"
                    name="confirmPassword"
                    type="password"
                    required
                    class="relative block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6 pl-2 mt-2"
                    placeholder="Confirmar Nova Senha"
                    minlength="8"
                />
            </div>

            <div>
                <button
                    type="submit"
                    class="group relative flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600"
                >
                    Redefinir Senha
                </button>
            </div>
        </form>
    </div>

    <script define:vars={{ token }}>
        import { authClient } from "@/lib/auth-client";
        import { toast } from "sonner";

        const form = document.getElementById("reset-password-form");

        if (form) {
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const password = formData.get("password");
                const confirmPassword = formData.get("confirmPassword");

                if (password !== confirmPassword) {
                    toast.error("As senhas nÃ£o coincidem.");
                    return;
                }

                const btn = form.querySelector("button");
                if (btn) {
                    btn.textContent = "Redefinindo...";
                    btn.disabled = true;
                }

                try {
                    const { error } = await authClient.resetPassword({
                        newPassword: password,
                        token,
                    });

                    if (error) {
                        toast.error(error.message);
                    } else {
                        toast.success("Senha redefinida com sucesso!");
                        setTimeout(() => {
                            window.location.href = "/login";
                        }, 2000);
                    }
                } catch (err) {
                    toast.error("Erro ao redefinir senha.");
                } finally {
                    if (btn) {
                        btn.textContent = "Redefinir Senha";
                        btn.disabled = false;
                    }
                }
            });
        }
    </script>
</Layout>
