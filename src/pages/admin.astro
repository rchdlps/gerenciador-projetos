---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { AdminDashboard } from "@/components/admin/dashboard";
import { auth } from "@/lib/auth";
import { db } from "@/lib/db";
import { users } from "../../db/schema";
import { eq } from "drizzle-orm";

const session = await auth.api.getSession({ headers: Astro.request.headers });

if (!session) {
    return Astro.redirect("/login");
}

// Double check global role (Database) to be secure
const [user] = await db
    .select()
    .from(users)
    .where(eq(users.id, session.user.id));

if (user?.globalRole !== "super_admin") {
    // For demo purposes, we might allow bypassing this check if seeding didn't set role correctly,
    // but for governance we enforce it.
    // In this environment, we migrated existing user. I should probably manually update the user to super_admin via seed or command.
    // For now, let's redirect to home if not admin.
    return Astro.redirect("/");
}
---

<DashboardLayout title="Admin - GestÃ£o de Secretarias">
    <AdminDashboard client:load />
</DashboardLayout>
