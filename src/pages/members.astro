---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { OrgMembersWrapper } from "@/components/members/wrapper";
import { getPageContext } from "@/lib/queries/page-context";

const ctx = await getPageContext(Astro.request.headers);
if (!ctx) return Astro.redirect("/login");

const { isSuperAdmin, activeOrgId, orgSessionData } = ctx;

// Check user's role in active org from orgSessionData (no extra DB query)
const userRole = orgSessionData?.activeOrganization?.role || null;
const canManage = isSuperAdmin || userRole === "secretario" || userRole === "gestor";
---

<DashboardLayout
    title="Membros da Organização"
    session={ctx.session}
    orgSessionData={orgSessionData}
>
    <OrgMembersWrapper
        client:only="react"
        organizationId={activeOrgId}
        canManage={canManage}
        userRole={userRole}
        isSuperAdmin={isSuperAdmin}
    />
</DashboardLayout>
