---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { NotificationDetails } from "@/components/notifications/NotificationDetails";
import { getNotificationById, markAsRead } from "@/lib/notification";
import { getPageContext } from "@/lib/queries/page-context";

const ctx = await getPageContext(Astro.request.headers);
if (!ctx) return Astro.redirect("/login");

const { id } = Astro.params;
if (!id) return Astro.redirect("/notifications");

const notification = await getNotificationById(id, ctx.user.id);
if (!notification) return Astro.redirect("/notifications?error=not-found");

// Mark as read (non-blocking — don't await, fire-and-forget)
if (!notification.isRead) {
    markAsRead(id, ctx.user.id).catch(() => {});
}

// Serialize for client component: Date → ISO string, parse JSON data
const clientNotification = {
    ...notification,
    createdAt: notification.createdAt instanceof Date
        ? notification.createdAt.toISOString()
        : String(notification.createdAt),
    data: notification.data ? JSON.parse(notification.data) : null,
};
---

<DashboardLayout
    title={notification.title}
    session={ctx.session}
    orgSessionData={ctx.orgSessionData}
>
  <div class="container mx-auto py-6">
    <NotificationDetails client:load notification={clientNotification} />
  </div>
</DashboardLayout>
