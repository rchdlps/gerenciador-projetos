---
import DashboardLayout from "@/layouts/DashboardLayout.astro";
import { NotificationDetails } from "@/components/notifications/NotificationDetails";
import { getNotificationById, markAsRead } from "@/lib/notification";
import { getPageContext } from "@/lib/queries/page-context";

const ctx = await getPageContext(Astro.request.headers);
if (!ctx) return Astro.redirect("/login");

const { id } = Astro.params;
if (!id) return Astro.redirect("/notifications");

const notification = await getNotificationById(id, ctx.user.id);
if (!notification) return Astro.redirect("/notifications?error=not-found");

// Mark as read (non-blocking â€” don't await, fire-and-forget)
if (!notification.isRead) {
    markAsRead(id, ctx.user.id).catch(() => {});
}
---

<DashboardLayout
    title={notification.title}
    session={ctx.session}
    orgSessionData={ctx.orgSessionData}
>
  <div class="container mx-auto py-6">
    <NotificationDetails client:load notification={notification} />
  </div>
</DashboardLayout>
